version: 2
plan:
  project-key: WCAB
  key: CAR
  name: car-build

variables:
  PROJECT_VERSION: ""

stages:
- Build CAR Appication:
    manual: false
    final: false
    jobs:
    - Build CAR File
Build CAR File:
  key: JOB1
  tasks:
  - checkout:
      force-clean-build: false
      description: clone project

  - script:
      interpreter: SHELL
      scripts:
      - 'mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.version'
      - 'mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.artifactId'
      - ${bamboo.PROJECT_VERSION} = 'mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.version'
      - echo ${bamboo.PROJECT_VERSION}
  - script:
      interpreter: SHELL
      scripts:
      - 'mvn clean install -Dmaven.test.skip=true'
  - script:
      interpreter: SHELL
      scripts:
      - ${bamboo.PROJECT_VERSION} = 'mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.version'
      - 'mvn deploy:deploy-file -Durl=http://localhost:8081/repository/wso2-snapshot-artifacts -DrepositoryId=nexus-snapshot-repo -Dfile=HostReferenceProjectCompositeExporter/target/HostReferenceProjectCompositeExporter_1.0.0-SNAPSHOT.car -DgroupId=com.wso2.reference -DartifactId=HostReferenceProject -Dversion=${bamboo.PROJECT_VERSION} -Dpackaging=car'
  # - script:
  #     interpreter: SHELL
  #     scripts:
  #     - 'curl -v -u admin:admin@123 --upload-file HostReferenceProjectCompositeExporter/target http://localhost:8081/repository/wso2-snapshot-artifacts/com.wso2.reference/HostReferenceProject/1.0.0-SNAPSHOT/HostReferenceProjectCompositeExporter_1.0.0-SNAPSHOT.car'
  artifacts:
  - name: CApp
    location: HostReferenceProjectCompositeExporter/target
    pattern: '*.car'
    shared: true
    required: true
  artifact-subscriptions: []
repositories:
- HostReferenceProject:
    type: git
    url: https://github.com/prasangab/hostreferenceproject
    branch: develop
    command-timeout-minutes: '180'
    lfs: false
    verbose-logs: false
    use-shallow-clones: false
    cache-on-agents: true
    submodules: false
    ssh-key-applies-to-submodules: true
    fetch-all: false
triggers: []
branches:
  create: manually
  delete: never
  link-to-jira: true
notifications: []
labels: []
dependencies:
  require-all-stages-passing: false
  enabled-for-branches: true
  block-strategy: none
  plans: []
other:
  concurrent-build-plugin: system-default