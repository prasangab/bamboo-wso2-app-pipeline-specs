version: 2
plan:
  project-key: WCAB
  key: CAR
  name: car-build

variables:
  PROJECT_VERSION: ""
  ARTIFACT_ID: "HostReferenceProject"

stages:
- Build CAR Appication:
    manual: false
    final: false
    jobs:
    - Build CAR File
Build CAR File:
  key: JOB1
  tasks:
  - checkout:
      force-clean-build: false
      description: clone project

  # - script:
  #     interpreter: SHELL
  #     scripts:
  #     - 'mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.version'
  # - script:
  #     interpreter: SHELL
  #     scripts:
  #     - 'mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.artifactId'
  - script:
      interpreter: SHELL
      scripts:
      - 'mvn clean install -Dmaven.test.skip=true'
  - script:
        interpreter: SHELL
        scripts:
        - |-
          #!/bin/bash
          PROJECT_VERSION=$(mvn exec:exec -Dexec.executable='echo' -Dexec.args='${project.version}' --non-recursive -q)
          echo "P_VERSION=$PROJECT_VERSION"
          ARTIFACT_ID=$(mvn exec:exec -Dexec.executable='echo' -Dexec.args='${project.artifactId}' --non-recursive -q)
          echo "A_ID=$ARTIFACT_ID"
          bamboo-cli --folder . --entry addVariable --variable PROJECT_VERSION --value $PROJECT_VERSION

  # - script:
  #     interpreter: SHELL
  #     scripts:
  #     - export PROJECT_VERSION=$(mvn exec:exec -Dexec.executable='echo' -Dexec.args='${project.version}' --non-recursive -q)
  - script:
      interpreter: SHELL
      scripts:
      - echo "bamboo.PROJECT_VERSION=${bamboo.PROJECT_VERSION}"
  # - script:
  #     interpreter: SHELL
  #     scripts:
  #     - 'mvn clean install -Dmaven.test.skip=true'
  - script:
      interpreter: SHELL
      scripts:
      - 'mvn deploy:deploy-file -Durl=http://localhost:8081/repository/wso2-snapshot-artifacts -DrepositoryId=nexus-snapshot-repo -Dfile=HostReferenceProjectCompositeExporter/target/${bamboo.ARTIFACT_ID}CompositeExporter_${bamboo.PROJECT_VERSION}.car -DgroupId=com.wso2.reference -DartifactId=${bamboo.ARTIFACT_ID} -Dversion=${bamboo.PROJECT_VERSION} -Dpackaging=car'
  artifacts:
  - name: ${bamboo.ARTIFACT_ID}CApp
    location: ${bamboo.ARTIFACT_ID}CompositeExporter/target
    pattern: '*.car'
    shared: true
    required: true
  artifact-subscriptions: []
repositories:
- HostReferenceProject:
    type: git
    url: https://github.com/prasangab/hostreferenceproject
    branch: develop
    command-timeout-minutes: '180'
    lfs: false
    verbose-logs: false
    use-shallow-clones: false
    cache-on-agents: true
    submodules: false
    ssh-key-applies-to-submodules: true
    fetch-all: false
triggers: []
branches:
  create: manually
  delete: never
  link-to-jira: true
notifications: []
labels: []
dependencies:
  require-all-stages-passing: false
  enabled-for-branches: true
  block-strategy: none
  plans: []
other:
  concurrent-build-plugin: system-default